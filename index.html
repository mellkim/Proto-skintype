# Create a corrected version of the uploaded index.html with unified hash routing,
# anchor fixes, removal of duplicate script logic, and deterministic report generation
# that maps diagnosis-based fields. The result is saved to /mnt/data/index.fixed.html

html = r"""<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í”¼ë¶€íŠ¹ì„±ë¶„ì„ì„œë¹„ìŠ¤ ì‹œë²”ì‚¬ì—… ë¦¬í¬íŠ¸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F7F4; color: #4A4A4A; }
    .main-container { display: flex; flex-direction: column; min-height: 100vh; }
    .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
    @media (min-width: 768px) { .chart-container { height: 400px; } }
    .modal-bg { background-color: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="bg-gray-100">

<header class="bg-white sticky top-0 z-50 shadow-md">
  <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
    <div class="text-2xl font-bold text-[#E07A5F]">ğŸ§¬ Gene-Skin Analytics</div>
    <div class="hidden md:flex space-x-6">
      <!-- fixed: use explicit hashes to avoid /# -->
      <a href="#reports" id="nav-reports" class="text-gray-600 hover:text-[#81B29A]">ë‚˜ì˜ ë¦¬í¬íŠ¸</a>
      <a href="#dashboard" id="nav-dashboard" class="text-gray-600 hover:text-[#81B29A]">ìœ ì „ì ëŒ€ì‹œë³´ë“œ</a>
    </div>
  </nav>
</header>

<main class="container mx-auto p-4 md:p-8 flex-1">
  <!-- ë¡œê·¸ì¸ í˜ì´ì§€ -->
  <div id="login-view" class="flex flex-col items-center justify-center min-h-[calc(100vh-80px)]">
    <div class="text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-[#3D405B] mb-4">ì‹œë²” ì‚¬ì—… ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ</h1>
      <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-8">
        ë¡œê·¸ì¸í•˜ì—¬ ê°œì¸ ìœ ì „ì ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”.
      </p>
      <button id="login-btn" class="bg-[#81B29A] text-white px-8 py-3 rounded-full shadow-md hover:bg-[#3D405B] transition-colors font-bold text-lg">
        <i class="fas fa-sign-in-alt mr-2"></i> ë¡œê·¸ì¸
      </button>
    </div>
  </div>

  <!-- ë¦¬í¬íŠ¸ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ -->
  <div id="reports-view" class="hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-[#3D405B]">ë‚˜ì˜ ì‹œí—˜ ë¦¬í¬íŠ¸</h2>
      <div class="flex items-center space-x-4">
        <span id="user-id-display" class="text-sm font-medium text-gray-500"></span>
        <button id="add-report-btn" class="bg-[#E07A5F] text-white px-4 py-2 rounded-full shadow-md hover:bg-[#A94C38] transition-colors font-bold text-sm">
          <i class="fas fa-plus mr-2"></i>ìƒˆ ë¦¬í¬íŠ¸ ì¶”ê°€
        </button>
      </div>
    </div>
    <div id="report-list-container" class="space-y-4"></div>
    <div id="no-reports" class="hidden text-center text-gray-500 mt-10">
      <p>ì•„ì§ ì €ì¥ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë¦¬í¬íŠ¸ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”!</p>
    </div>
  </div>

  <!-- ìœ ì „ì ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ -->
  <div id="gene-dashboard-view" class="hidden">
    <h2 class="text-3xl font-bold text-center text-[#3D405B] mb-8">ì¸í„°ë™í‹°ë¸Œ ìœ ì „ì ëŒ€ì‹œë³´ë“œ</h2>
    <p class="text-center text-gray-600 mb-10">ì•„ë˜ í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ì‹¬ìˆëŠ” í”¼ë¶€ ê³ ë¯¼ì„ ì„ íƒí•˜ê³ , ê° ìœ ì „ì ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
    <div id="gene-filters" class="flex justify-center space-x-2 md:space-x-4 mb-8">
      <button data-filter="all" class="filter-btn bg-[#E07A5F] text-white px-4 py-2 rounded-full shadow">ì „ì²´ë³´ê¸°</button>
      <button data-filter="ë…¸í™”" class="filter-btn bg-white text-[#3D405B] px-4 py-2 rounded-full shadow">â³ í”¼ë¶€ ë…¸í™”</button>
      <button data-filter="ìƒ‰ì†Œ" class="filter-btn bg-white text-[#3D405B] px-4 py-2 rounded-full shadow">â˜€ï¸ í”¼ë¶€ ìƒ‰ì†Œ</button>
      <button data-filter="ê±´ì¡°" class="filter-btn bg-white text-[#3D405B] px-4 py-2 rounded-full shadow">ğŸ’§ í”¼ë¶€ ê±´ì¡°</button>
    </div>
    <div id="gene-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
  </div>

  <!-- ë¦¬í¬íŠ¸ ìƒì„¸ í˜ì´ì§€ -->
  <div id="detail-view" class="hidden">
    <button id="back-to-list-btn" class="mb-4 text-gray-600 hover:text-[#3D405B] transition-colors">
      <i class="fas fa-arrow-left mr-2"></i> ë¦¬í¬íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    </button>
    <div id="report-detail-container" class="bg-white rounded-2xl shadow-lg p-6 md:p-8"></div>
  </div>

  <!-- ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
      <h3 class="text-xl font-bold text-red-600 mb-4">ì•Œë¦¼</h3>
      <p id="modal-message" class="text-gray-700"></p>
      <div class="mt-6 text-right">
        <button id="modal-close-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200">
          ë‹«ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- ìœ ì „ì ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
  <div id="gene-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
    <div class="modal-bg fixed inset-0"></div>
    <div class="bg-white rounded-lg shadow-xl m-4 md:m-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-6">
      <button id="close-gene-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <div id="gene-modal-content"></div>
    </div>
  </div>
</main>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ===== Global config (kept as in original) =====
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const app = initializeApp(firebaseConfig, appId);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== Gene master data (11 genes) =====
  const geneData = {
    "COL1A1": { name: "COL1A1", category: "ë…¸í™”",
      description: "í”¼ë¶€ êµ¬ì¡°ì˜ 90%ë¥¼ ì°¨ì§€í•˜ëŠ” 1í˜• ì½œë¼ê² í•©ì„±.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">ì½œë¼ê² ì•ŒíŒŒ-1 ì‚¬ìŠ¬ì„ í•©ì„±í•˜ì—¬ í”¼ë¶€ ì¡°ì§ì„ ê°•í™”í•©ë‹ˆë‹¤.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li><strong>í©íƒ€ì´ë“œ</strong> / <strong>ë¹„íƒ€ë¯¼ C</strong> / <strong>ì»´íŒŒìš´ë“œ K</strong></li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ë””ì˜¤ë””ë„ˆë¦¬ í©íƒ€ì´ë“œ ì„¸ëŸ¼, ì„¤í™”ìˆ˜ ììŒìƒ ë¼ì¸</p>`
    },
    "PINK1": { name: "PINK1", category: "ë…¸í™”",
      description: "ì†ìƒ ë¯¸í† ì½˜ë“œë¦¬ì•„ ì œê±°(ë¯¸í† íŒŒì§€) ì¡°ì ˆ.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">Parkinì„ í†µí•´ ë¯¸í† íŒŒì§€ë¥¼ ìœ ë„í•©ë‹ˆë‹¤.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ì•„ìŠ¤íƒ€ì”í‹´, ë°±ë¯¸ê½ƒ ì¶”ì¶œë¬¼, NAD+</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ì•„ìŠ¤íƒ€ì”í‹´ ì„¸ëŸ¼, ë¹„ì²© ììƒ ì—ì„¼ìŠ¤</p>`
    },
    "HAS2": { name: "HAS2", category: "ë…¸í™”",
      description: "íˆì•Œë£¨ë¡ ì‚° í•©ì„±ìœ¼ë¡œ ë³´ìŠµ ìœ ì§€.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">íˆì•Œë£¨ë¡ ì‚° í•©ì„± íš¨ì†Œ.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>í”¼ì„¸ì•„íƒ„ë†€, ì„¤í“¨ë ˆí‹´</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ë„¤ì˜¤ì   V.BIOME ë¼ì¸</p>`
    },
    "MSN": { name: "MSN", category: "ë…¸í™”",
      description: "ì„¸í¬ë§‰-ì„¸í¬ê³¨ê²© ì—°ê²°ë¡œ í˜•íƒœ/ì´ë™ ê´€ì—¬.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">ì„¸í¬ í˜•íƒœ ìœ ì§€ì™€ ì´ë™ì— í•„ìˆ˜.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>í©íƒ€ì´ë“œ(ì¹´í…”ë¦¬ì‹œë”˜)</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ì§ì ‘ í‘œì  ì œí’ˆ ë¯¸í™•ì¸</p>`
    },
    "MLANA": { name: "MLANA", category: "ìƒ‰ì†Œ",
      description: "ë©œë¼ë…¸ì¢€ í˜•ì„± ê´€ì—¬, í”¼ë¶€ í†¤ì— ì˜í–¥.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">MITF ì¡°ì ˆ í•˜ì— ë©œë¼ë…¸ì¢€ í˜•ì„±.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ë ˆìŠ¤ë² ë¼íŠ¸ë¡¤, EGCG, ì•Œë¶€í‹´, ì½”ì§ì‚°</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ìœ ì„¸ë¦° ì•ˆí‹°-í”¼ê·¸ë¨¼íŠ¸ ë¼ì¸</p>`
    },
    "TFAP2A": { name: "TFAP2A", category: "ìƒ‰ì†Œ",
      description: "ë©œë¼ë‹Œ í•©ì„± ìœ ì „ì ë°œí˜„ ì¡°ì ˆ ì „ì‚¬ì¸ì.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">ë©œë¼ë‹Œì„¸í¬ ë¶„í™” ë° í•©ì„± ì¡°ì ˆ.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ë ˆí‹°ë…¸ì´ë“œ (ê°„ì ‘)</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ë ˆí‹´-A(ì²˜ë°©)</p>`
    },
    "SOD1": { name: "SOD1", category: "ìƒ‰ì†Œ",
      description: "í™œì„±ì‚°ì†Œ ì œê±° í•µì‹¬ í•­ì‚°í™” íš¨ì†Œ.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">ROSë¥¼ ë¶„í•´í•´ ê´‘ë…¸í™” ì–µì œ.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ë ˆìŠ¤ë² ë¼íŠ¸ë¡¤, EGCG, ë¹„íƒ€ë¯¼ C</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ë¦¬ì˜ë“œ SOD ì•°í”Œ</p>`
    },
    "VDR": { name: "VDR", category: "ìƒ‰ì†Œ",
      description: "ë¹„íƒ€ë¯¼ D ìˆ˜ìš©ì²´, ë¶„í™”Â·ë©´ì—­Â·ìƒ‰ì†Œ ê´€ì—¬.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">í™œì„± ë¹„íƒ€ë¯¼ D ê²°í•© í›„ ì „ì‚¬ ì¡°ì ˆ.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ë¹„íƒ€ë¯¼ D3, ë ˆí‹°ë…¸ì´ë“œ(RXR êµì°¨)</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ìŠ¤í‚¨ ì˜¤ì†Œë¦¬í‹° D3+ ì„¸ëŸ¼</p>`
    },
    "FLG": { name: "FLG", category: "ê±´ì¡°",
      description: "í•„ë¼ê·¸ë¦° ìƒì„±ìœ¼ë¡œ ì¥ë²½/NMF í˜•ì„±.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">ê°ì§ˆì¸µ ì¥ë²½ê³¼ NMF ìƒì„±.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ë‚˜ì´ì•„ì‹ ì•„ë§ˆì´ë“œ, ìš°ë ˆì•„, ì•„í”¼ê²Œë‹Œ</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ë‹¥í„°ì§€ í•„ë¼ê·¸ë¦°, ì œë¡œì´ë“œ ë¦¬ì²´ë‹‰</p>`
    },
    "AQP3": { name: "AQP3", category: "ê±´ì¡°",
      description: "ìˆ˜ë¶„/ê¸€ë¦¬ì„¸ë¡¤ í†µë¡œë¡œ ìˆ˜ë¶„ ê· í˜• ì¡°ì ˆ.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">í‘œí”¼ ìˆ˜ë¶„ ìˆ˜ì†¡ ì±„ë„.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ê¸€ë¦¬ì„¸ë¦´ê¸€ë£¨ì½”ì‚¬ì´ë“œ, ë³‘í’€ì¶”ì¶œë¬¼</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ìœ ì„¸ë¦° ì•„ì¿ ì•„í¬ë¦°, ìŠ¤í‚¨1004</p>`
    },
    "SPINK5": { name: "SPINK5", category: "ê±´ì¡°",
      description: "ì„¸ë¦° í”„ë¡œí…Œì•„ì œ ì–µì œë¡œ ê°ì§ˆ íƒˆë½ ì¡°ì ˆ.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ìœ ì „ì ì—­í•  ë° ê²½ë¡œ</h4>
        <p class="mb-4">LEKTIë¡œ ê°ì§ˆì¸µ íš¨ì†Œ ì–µì œ.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì¡°ì ˆ ì„±ë¶„ ë° ê¸°ì „</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>ë””ì˜¤ìŠ¤ë©”í‹´, ì»´íŒŒìš´ë“œ K</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">ì‹œì¤‘ ì œí’ˆ ì˜ˆì‹œ</h4>
        <p>ì„¤í™”ìˆ˜(ì˜ˆ)</p>`
    }
  };

  // mean expression per age/sex (shortened same structure; values as in original)
  const expressionData = {
    "COL1A1": { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[12.76,13.74,12.52,12.24,11.76], female:[10.23,10.79,11.26,12.67,15.07] },
    "PINK1":  { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[-0.15,4.59,4.29,2.86,2.31],   female:[2.38,2.94,3.78,4.18,6.53] },
    "MSN":    { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[3.50,6.77,5.93,5.28,6.80],   female:[3.60,5.13,7.09,7.29,7.48] },
    "HAS2":   { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[11.04,5.14,11.82,10.41,7.21], female:[9.10,10.71,4.83,13.91,15.51] },
    "MLANA":  { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[6.11,2.22,2.47,2.19,-0.36],  female:[5.30,1.84,0.56,1.23,0.93] },
    "TFAP2A": { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[7.61,8.80,9.89,9.67,8.12],   female:[7.11,7.62,8.69,7.10,8.49] },
    "SOD1":   { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[-2.42,-3.52,-1.88,-3.54,-3.77], female:[-1.75,-2.58,-2.20,-2.27,-2.81] },
    "VDR":    { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[2.98,4.28,3.49,5.77,5.24],   female:[2.33,3.15,3.45,3.66,3.16] },
    "FLG":    { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[-2.69,-1.32,0.39,-4.97,-5.31], female:[-0.97,-1.20,-1.89,-1.85,0.18] },
    "AQP3":   { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[2.22,4.74,4.94,2.97,4.93],   female:[5.11,4.37,3.10,4.71,2.76] },
    "SPINK5": { labels: ["20ëŒ€","30ëŒ€","40ëŒ€","50ëŒ€","60ëŒ€"], male:[-0.28,1.26,2.15,-0.44,0.24], female:[0.36,1.71,-0.32,0.62,3.25] }
  };

  // diagnosis mapping
  const recommendationData = {
    "COL1A1": {
      high:{status:"ë†’ìŒ",message:"ì½œë¼ê² í•©ì„±ì´ í‰ê· ë³´ë‹¤ ë†’ìŒ.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ë³´ìŠµ/ìì°¨ ìœ ì§€"},
      low: {status:"ë‚®ìŒ",message:"ì½œë¼ê² í•©ì„±ì´ í‰ê· ë³´ë‹¤ ë‚®ìŒ.",ingredients:"í©íƒ€ì´ë“œ, ë¹„íƒ€ë¯¼ C, ì»´íŒŒìš´ë“œ K",products:"í©íƒ€ì´ë“œ ì„¸ëŸ¼ ë“±",tips:"ë‹¨ë°±ì§ˆ ì„­ì·¨/ìš´ë™"}
    },
    "PINK1": {
      high:{status:"ë†’ìŒ",message:"ë¯¸í† íŒŒì§€ ê¸°ëŠ¥ ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"í•­ì‚°í™” ì„­ì·¨/ìˆ˜ë©´"},
      low: {status:"ë‚®ìŒ",message:"ë¯¸í† íŒŒì§€ ê¸°ëŠ¥ ì €í•˜.",ingredients:"ì•„ìŠ¤íƒ€ì”í‹´, NAD+",products:"ì•„ìŠ¤íƒ€ì”í‹´ ì„¸ëŸ¼ ë“±",tips:"í•­ì‚°í™” ìœ„ì£¼ ì¼€ì–´"}
    },
    "MSN": {
      high:{status:"ë†’ìŒ",message:"ì„¸í¬ ì´ë™ ê¸°ëŠ¥ ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ìê·¹ ìµœì†Œí™”"},
      low: {status:"ë‚®ìŒ",message:"ì¬ìƒ ëŠ¥ë ¥ ì €í•˜ ê°€ëŠ¥.",ingredients:"í©íƒ€ì´ë“œ(ì¹´í…”ë¦¬ì‹œë”˜)",products:"í©íƒ€ì´ë“œ ì œí’ˆ",tips:"ì¬ìƒ ì„±ë¶„ ìœ„ì£¼"}
    },
    "HAS2": {
      high:{status:"ë†’ìŒ",message:"íˆì•Œë£¨ë¡ ì‚° í•©ì„± ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ìˆ˜ë¶„ ìœ ì§€"},
      low: {status:"ë‚®ìŒ",message:"ê±´ì¡°/íƒ„ë ¥ ì €í•˜ ìš°ë ¤.",ingredients:"í”¼ì„¸ì•„íƒ„ë†€, ì„¤í“¨ë ˆí‹´",products:"ë„¤ì˜¤ì   V.BIOME",tips:"ìˆ˜ë¶„ ì¶©ì „"}
    },
    "MLANA": {
      high:{status:"ë†’ìŒ",message:"ìƒ‰ì†Œ ì¹¨ì°© ê²½í–¥ â†‘.",ingredients:"ë ˆìŠ¤ë² ë¼íŠ¸ë¡¤, EGCG, ì•Œë¶€í‹´",products:"í‹°ì•„ë¯¸ëŒ ë¼ì¸",tips:"ìì°¨/ë¯¸ë°±"},
      low: {status:"ë‚®ìŒ",message:"ë§‘ì€ í†¤ ê²½í–¥.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ìì°¨ ìœ ì§€"}
    },
    "TFAP2A": {
      high:{status:"ë†’ìŒ",message:"ìƒ‰ì†Œ ì¡°ì ˆ â†‘.",ingredients:"ë ˆí‹°ë…¸ì´ë“œ",products:"ë ˆí‹´-A(ì²˜ë°©)",tips:"ìê·¹ ì£¼ì˜"},
      low: {status:"ë‚®ìŒ",message:"ìƒ‰ì†Œ ì¡°ì ˆ â†“.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ìì°¨ ìœ ì§€"}
    },
    "SOD1": {
      high:{status:"ë†’ìŒ",message:"í•­ì‚°í™” ë°©ì–´ ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"í•­ì‚°í™” ìŠµê´€"},
      low: {status:"ë‚®ìŒ",message:"ìƒ‰ì†Œ/ë…¸í™” ê°€ì† ìš°ë ¤.",ingredients:"ë ˆìŠ¤ë² ë¼íŠ¸ë¡¤, EGCG, ë¹„íƒ€ë¯¼ C",products:"SOD ì•°í”Œ ë“±",tips:"í•­ì‚°í™” ë³´ê°•"}
    },
    "VDR": {
      high:{status:"ë†’ìŒ",message:"VDR í™œì„± ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"D3 ê´€ë¦¬"},
      low: {status:"ë‚®ìŒ",message:"ë©´ì—­/ìƒ‰ì†Œ ì·¨ì•½.",ingredients:"ë¹„íƒ€ë¯¼ D3, ë ˆí‹°ë…¸ì´ë“œ",products:"D3+ ì„¸ëŸ¼",tips:"ìì°¨/ì¥ë²½ë³´ê°•"}
    },
    "FLG": {
      high:{status:"ë†’ìŒ",message:"ì¥ë²½ íŠ¼íŠ¼.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ì €ìê·¹ ì¼€ì–´"},
      low: {status:"ë‚®ìŒ",message:"ì¥ë²½ ì•½í™”/ê±´ì¡°.",ingredients:"ë‹ˆì•„ì‹ ì•„ë§ˆì´ë“œ, ìš°ë ˆì•„, ì•„í”¼ê²Œë‹Œ",products:"í•„ë¼ê·¸ë¦°/ìš°ë ˆì•„",tips:"ë³´ìŠµ/ì¥ë²½ë³´ê°•"}
    },
    "AQP3": {
      high:{status:"ë†’ìŒ",message:"ìˆ˜ë¶„ í†µë¡œ ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ë³´ìŠµ ìœ ì§€"},
      low: {status:"ë‚®ìŒ",message:"ê±´ì¡°/íƒ„ë ¥ ì €í•˜.",ingredients:"ê¸€ë¦¬ì„¸ë¦´ê¸€ë£¨ì½”ì‚¬ì´ë“œ, ë³‘í’€",products:"ì•„ì¿ ì•„í¬ë¦°/ì„¼í…”ë¼",tips:"ìˆ˜ë¶„ì±„ë„ í™œì„±"}
    },
    "SPINK5": {
      high:{status:"ë†’ìŒ",message:"ê°ì§ˆ ì¡°ì ˆ ì–‘í˜¸.",ingredients:"í•´ë‹¹ ì—†ìŒ",products:"í˜„ì¬ ê´€ë¦¬ ìœ ì§€",tips:"ì €ìê·¹"},
      low: {status:"ë‚®ìŒ",message:"ì¥ë²½ ì†ìƒ ìš°ë ¤.",ingredients:"ë””ì˜¤ìŠ¤ë©”í‹´, ì»´íŒŒìš´ë“œ K",products:"ì„¤í™”ìˆ˜ ë¼ì¸",tips:"ì¥ë²½ ê°•í™”"}
    }
  };

  // ===== DOM =====
  const loginView = document.getElementById('login-view');
  const reportsView = document.getElementById('reports-view');
  const detailView = document.getElementById('detail-view');
  const geneDashboardView = document.getElementById('gene-dashboard-view');
  const loginBtn = document.getElementById('login-btn');
  const addReportBtn = document.getElementById('add-report-btn');
  const backToListBtn = document.getElementById('back-to-list-btn');
  const navReportsBtn = document.getElementById('nav-reports');
  const navDashboardBtn = document.getElementById('nav-dashboard');
  const reportListContainer = document.getElementById('report-list-container');
  const reportDetailContainer = document.getElementById('report-detail-container');
  const noReportsMessage = document.getElementById('no-reports');
  const userIdDisplay = document.getElementById('user-id-display');
  const geneGrid = document.getElementById('gene-grid');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const geneModal = document.getElementById('gene-modal');
  const closeModalBtn = document.getElementById('close-gene-modal');
  const geneModalContent = document.getElementById('gene-modal-content');
  const modal = document.getElementById('modal');
  const modalMessage = document.getElementById('modal-message');
  const modalCloseBtnAlert = document.getElementById('modal-close-btn');

  let currentUserId = null;

  // ===== UI helpers =====
  const showMessageModal = (message) => { modalMessage.textContent = message; modal.classList.remove('hidden'); };
  modalCloseBtnAlert.addEventListener('click', () => modal.classList.add('hidden'));

  const toggleViews = (view) => {
    loginView.classList.add('hidden');
    reportsView.classList.add('hidden');
    detailView.classList.add('hidden');
    geneDashboardView.classList.add('hidden');
    if (view === 'login') loginView.classList.remove('hidden');
    else if (view === 'reports') reportsView.classList.remove('hidden');
    else if (view === 'detail') detailView.classList.remove('hidden');
    else if (view === 'gene-dashboard') geneDashboardView.classList.remove('hidden');
  };

  // ===== Router (single source of truth) =====
  function route() {
    const page = (location.hash || '#reports').replace('#', '');
    if (!currentUserId) { toggleViews('login'); return; }
    if (page === 'reports') toggleViews('reports');
    else if (page === 'dashboard') { toggleViews('gene-dashboard'); renderGeneCards('all'); }
    else if (page === 'detail') toggleViews('detail');
    else toggleViews('reports');
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  // ===== Detail rendering =====
  const renderDetailedReport = (reportData) => {
    reportDetailContainer.innerHTML = `
      <h2 class="text-3xl font-bold text-[#3D405B] mb-4">ì‹œí—˜ ë¦¬í¬íŠ¸ #${reportData.reportId}</h2>
      <p class="text-sm text-gray-500 mb-6">ì‘ì„±ì¼: ${reportData.createdAt?.toDate ? reportData.createdAt.toDate().toLocaleString() : 'ë‚ ì§œ ì—†ìŒ'}</p>
      <div class="bg-[#F0F4F8] rounded-lg shadow-inner p-6 mb-8">
        <h3 class="text-2xl font-bold text-[#3D405B] mb-4">ê°œì¸ ìœ ì „ì ê°’ ë¶„ì„ ê²°ê³¼</h3>
        <div class="space-y-4">
          <p><strong>ìœ ì „ì:</strong> ${reportData.gene}</p>
          <p><strong>ì—°ë ¹ëŒ€/ì„±ë³„:</strong> ${reportData.age} / ${reportData.gender}</p>
          <p><strong>ì¸¡ì •ê°’:</strong> ${Number(reportData.value).toFixed(2)}</p>
          <p><strong>ì§„ë‹¨:</strong> <span class="font-bold">${reportData.status}</span></p>
          <p><strong>ìƒì„¸ ë¶„ì„:</strong> ${reportData.message}</p>
          <p><strong>ì¶”ì²œ ì„±ë¶„:</strong> ${reportData.ingredients}</p>
          <p><strong>ì¶”ì²œ ì œí’ˆ:</strong> ${reportData.products}</p>
          <p><strong>ë§ì¶¤ íŒ:</strong> ${reportData.tips}</p>
        </div>
      </div>`;
    location.hash = 'detail';
  };

  // ===== Firestore: fetch user's reports =====
  const fetchReports = (userId) => {
    const reportsColRef = collection(db, \`artifacts/\${appId}/public/data/reports\`);
    const reportsQuery = query(reportsColRef, where("userId", "==", userId));
    onSnapshot(reportsQuery, (snapshot) => {
      const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      reportListContainer.innerHTML = '';
      if (reports.length === 0) {
        noReportsMessage.classList.remove('hidden');
        return;
      }
      noReportsMessage.classList.add('hidden');
      // latest first
      reports.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      reports.forEach(report => {
        const reportCard = document.createElement('div');
        reportCard.className = 'bg-white rounded-lg shadow-md p-4 cursor-pointer hover:bg-gray-50 transition-colors';
        const reportDate = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleString() : 'ë‚ ì§œ ì—†ìŒ';
        reportCard.innerHTML = \`
          <p class="text-xl font-bold text-[#3D405B]">ì‹œí—˜ ë¦¬í¬íŠ¸ #\${report.reportId}</p>
          <p class="text-sm text-gray-500">ì‘ì„±ì¼: \${reportDate}</p>\`;
        reportCard.addEventListener('click', () => {
          // prefer stored fields; if missing, recompute
          const ageIndex = expressionData[report.gene]?.labels.indexOf(report.age) ?? -1;
          let computed = null;
          if (ageIndex >= 0) {
            const mean = report.gender === 'ë‚¨ì„±'
              ? expressionData[report.gene].male[ageIndex]
              : expressionData[report.gene].female[ageIndex];
            const statusKey = (Number(report.value) > mean) ? 'high' : 'low';
            computed = recommendationData[report.gene][statusKey];
          }
          const full = {
            ...report,
            status: report.status || computed?.status || 'ì •ë³´ì—†ìŒ',
            message: report.message || computed?.message || 'ì •ë³´ì—†ìŒ',
            ingredients: report.ingredients || computed?.ingredients || 'ì •ë³´ì—†ìŒ',
            products: report.products || computed?.products || 'ì •ë³´ì—†ìŒ',
            tips: report.tips || computed?.tips || 'ì •ë³´ì—†ìŒ',
          };
          renderDetailedReport(full);
        });
        reportListContainer.appendChild(reportCard);
      });
    }, (error) => {
      console.error("Error fetching reports:", error);
      showMessageModal(\`ë¦¬í¬íŠ¸ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜: \${error.message}\`);
    });
  };

  // ===== Dashboard =====
  const renderGeneCards = (filter = 'all') => {
    geneGrid.innerHTML = '';
    Object.values(geneData).forEach(gene => {
      if (filter === 'all' || gene.category === filter) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow';
        card.innerHTML = \`
          <h3 class="font-bold text-xl mb-2 text-[#3D405B]">\${gene.name}</h3>
          <p class="text-gray-600">\${gene.description}</p>\`;
        card.onclick = () => showGeneDetails(gene);
        geneGrid.appendChild(card);
      }
    });
  };
  const showGeneDetails = (gene) => {
    geneModalContent.innerHTML = \`
      <h2 class="text-3xl font-bold text-[#E07A5F] mb-4">\${gene.name} (\${gene.category})</h2>
      <p class="text-gray-600 mb-6">\${gene.description}</p>
      <div class="space-y-6 text-gray-700">\${gene.details}</div>\`;
    geneModal.classList.remove('hidden'); geneModal.classList.add('flex');
  };
  closeModalBtn.addEventListener('click', () => geneModal.classList.add('hidden'));
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => { b.classList.remove('bg-[#E07A5F]','text-white'); b.classList.add('bg-white','text-[#3D405B]'); });
      btn.classList.remove('bg-white','text-[#3D405B]'); btn.classList.add('bg-[#E07A5F]','text-white');
      renderGeneCards(btn.dataset.filter);
    });
  });

  // ===== Auth & navigation =====
  loginBtn.addEventListener('click', async () => {
    try { await signInAnonymously(auth); }
    catch (e) { console.error(e); showMessageModal(\`ë¡œê·¸ì¸ ì˜¤ë¥˜: \${e.message}\`); }
  });
  backToListBtn.addEventListener('click', () => { location.hash = 'reports'; });
  // anchors already have hashes; no JS override needed, but keep safety:
  navReportsBtn.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='reports'; });
  navDashboardBtn.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='dashboard'; });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserId = user.uid;
      userIdDisplay.textContent = \`ì‚¬ìš©ì ID: \${currentUserId}\`;
      if (location.hash !== '#reports') location.hash = 'reports';
      fetchReports(currentUserId);
    } else {
      currentUserId = null;
      location.hash = '#login';
      toggleViews('login');
    }
  });

  // initial sign-in on page load
  (async () => {
    try { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); }
    catch (error) { console.error("Initial login failed:", error); showMessageModal(\`ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨: \${error.message}\`); }
  })();
</script>

<!-- NOTE: the duplicate non-module script block from the original file was intentionally REMOVED -->
</body>
</html>
"""

with open('/mnt/data/index.fixed.html', 'w', encoding='utf-8') as f:
    f.write(html)

print("Saved to /mnt/data/index.fixed.html")
