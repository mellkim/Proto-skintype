# Create a corrected version of the uploaded index.html with unified hash routing,
# anchor fixes, removal of duplicate script logic, and deterministic report generation
# that maps diagnosis-based fields. The result is saved to /mnt/data/index.fixed.html

html = r"""<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>피부특성분석서비스 시범사업 리포트</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F7F4; color: #4A4A4A; }
    .main-container { display: flex; flex-direction: column; min-height: 100vh; }
    .chart-container { position: relative; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
    @media (min-width: 768px) { .chart-container { height: 400px; } }
    .modal-bg { background-color: rgba(0,0,0,0.5); }
  </style>
</head>
<body class="bg-gray-100">

<header class="bg-white sticky top-0 z-50 shadow-md">
  <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
    <div class="text-2xl font-bold text-[#E07A5F]">🧬 Gene-Skin Analytics</div>
    <div class="hidden md:flex space-x-6">
      <!-- fixed: use explicit hashes to avoid /# -->
      <a href="#reports" id="nav-reports" class="text-gray-600 hover:text-[#81B29A]">나의 리포트</a>
      <a href="#dashboard" id="nav-dashboard" class="text-gray-600 hover:text-[#81B29A]">유전자 대시보드</a>
    </div>
  </nav>
</header>

<main class="container mx-auto p-4 md:p-8 flex-1">
  <!-- 로그인 페이지 -->
  <div id="login-view" class="flex flex-col items-center justify-center min-h-[calc(100vh-80px)]">
    <div class="text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-[#3D405B] mb-4">시범 사업 리포트 시스템</h1>
      <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-8">
        로그인하여 개인 유전자 분석 리포트를 확인하고 관리하세요.
      </p>
      <button id="login-btn" class="bg-[#81B29A] text-white px-8 py-3 rounded-full shadow-md hover:bg-[#3D405B] transition-colors font-bold text-lg">
        <i class="fas fa-sign-in-alt mr-2"></i> 로그인
      </button>
    </div>
  </div>

  <!-- 리포트 리스트 페이지 -->
  <div id="reports-view" class="hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-[#3D405B]">나의 시험 리포트</h2>
      <div class="flex items-center space-x-4">
        <span id="user-id-display" class="text-sm font-medium text-gray-500"></span>
        <button id="add-report-btn" class="bg-[#E07A5F] text-white px-4 py-2 rounded-full shadow-md hover:bg-[#A94C38] transition-colors font-bold text-sm">
          <i class="fas fa-plus mr-2"></i>새 리포트 추가
        </button>
      </div>
    </div>
    <div id="report-list-container" class="space-y-4"></div>
    <div id="no-reports" class="hidden text-center text-gray-500 mt-10">
      <p>아직 저장된 리포트가 없습니다. 새로운 리포트를 추가해 보세요!</p>
    </div>
  </div>

  <!-- 유전자 대시보드 페이지 -->
  <div id="gene-dashboard-view" class="hidden">
    <h2 class="text-3xl font-bold text-center text-[#3D405B] mb-8">인터랙티브 유전자 대시보드</h2>
    <p class="text-center text-gray-600 mb-10">아래 필터를 사용하여 관심있는 피부 고민을 선택하고, 각 유전자 카드를 클릭하여 상세 정보를 확인하세요.</p>
    <div id="gene-filters" class="flex justify-center space-x-2 md:space-x-4 mb-8">
      <button data-filter="all" class="filter-btn bg-[#E07A5F] text-white px-4 py-2 rounded-full shadow">전체보기</button>
      <button data-filter="노화" class="filter-btn bg-white text-[#3D405B] px-4 py-2 rounded-full shadow">⏳ 피부 노화</button>
      <button data-filter="색소" class="filter-btn bg-white text-[#3D405B] px-4 py-2 rounded-full shadow">☀️ 피부 색소</button>
      <button data-filter="건조" class="filter-btn bg-white text-[#3D405B] px-4 py-2 rounded-full shadow">💧 피부 건조</button>
    </div>
    <div id="gene-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
  </div>

  <!-- 리포트 상세 페이지 -->
  <div id="detail-view" class="hidden">
    <button id="back-to-list-btn" class="mb-4 text-gray-600 hover:text-[#3D405B] transition-colors">
      <i class="fas fa-arrow-left mr-2"></i> 리포트 목록으로 돌아가기
    </button>
    <div id="report-detail-container" class="bg-white rounded-2xl shadow-lg p-6 md:p-8"></div>
  </div>

  <!-- 커스텀 알림 모달 -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
      <h3 class="text-xl font-bold text-red-600 mb-4">알림</h3>
      <p id="modal-message" class="text-gray-700"></p>
      <div class="mt-6 text-right">
        <button id="modal-close-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200">
          닫기
        </button>
      </div>
    </div>
  </div>

  <!-- 유전자 상세 정보 모달 -->
  <div id="gene-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
    <div class="modal-bg fixed inset-0"></div>
    <div class="bg-white rounded-lg shadow-xl m-4 md:m-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-6">
      <button id="close-gene-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      <div id="gene-modal-content"></div>
    </div>
  </div>
</main>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ===== Global config (kept as in original) =====
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  const app = initializeApp(firebaseConfig, appId);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ===== Gene master data (11 genes) =====
  const geneData = {
    "COL1A1": { name: "COL1A1", category: "노화",
      description: "피부 구조의 90%를 차지하는 1형 콜라겐 합성.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">콜라겐 알파-1 사슬을 합성하여 피부 조직을 강화합니다.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li><strong>펩타이드</strong> / <strong>비타민 C</strong> / <strong>컴파운드 K</strong></li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>디오디너리 펩타이드 세럼, 설화수 자음생 라인</p>`
    },
    "PINK1": { name: "PINK1", category: "노화",
      description: "손상 미토콘드리아 제거(미토파지) 조절.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">Parkin을 통해 미토파지를 유도합니다.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>아스타잔틴, 백미꽃 추출물, NAD+</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>아스타잔틴 세럼, 비첩 자생 에센스</p>`
    },
    "HAS2": { name: "HAS2", category: "노화",
      description: "히알루론산 합성으로 보습 유지.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">히알루론산 합성 효소.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>피세아탄놀, 설퓨레틴</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>네오젠 V.BIOME 라인</p>`
    },
    "MSN": { name: "MSN", category: "노화",
      description: "세포막-세포골격 연결로 형태/이동 관여.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">세포 형태 유지와 이동에 필수.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>펩타이드(카텔리시딘)</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>직접 표적 제품 미확인</p>`
    },
    "MLANA": { name: "MLANA", category: "색소",
      description: "멜라노좀 형성 관여, 피부 톤에 영향.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">MITF 조절 하에 멜라노좀 형성.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>레스베라트롤, EGCG, 알부틴, 코직산</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>유세린 안티-피그먼트 라인</p>`
    },
    "TFAP2A": { name: "TFAP2A", category: "색소",
      description: "멜라닌 합성 유전자 발현 조절 전사인자.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">멜라닌세포 분화 및 합성 조절.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>레티노이드 (간접)</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>레틴-A(처방)</p>`
    },
    "SOD1": { name: "SOD1", category: "색소",
      description: "활성산소 제거 핵심 항산화 효소.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">ROS를 분해해 광노화 억제.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>레스베라트롤, EGCG, 비타민 C</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>리쏘드 SOD 앰플</p>`
    },
    "VDR": { name: "VDR", category: "색소",
      description: "비타민 D 수용체, 분화·면역·색소 관여.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">활성 비타민 D 결합 후 전사 조절.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>비타민 D3, 레티노이드(RXR 교차)</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>스킨 오소리티 D3+ 세럼</p>`
    },
    "FLG": { name: "FLG", category: "건조",
      description: "필라그린 생성으로 장벽/NMF 형성.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">각질층 장벽과 NMF 생성.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>나이아신아마이드, 우레아, 아피게닌</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>닥터지 필라그린, 제로이드 리체닉</p>`
    },
    "AQP3": { name: "AQP3", category: "건조",
      description: "수분/글리세롤 통로로 수분 균형 조절.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">표피 수분 수송 채널.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>글리세릴글루코사이드, 병풀추출물</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>유세린 아쿠아포린, 스킨1004</p>`
    },
    "SPINK5": { name: "SPINK5", category: "건조",
      description: "세린 프로테아제 억제로 각질 탈락 조절.",
      details: `
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">유전자 역할 및 경로</h4>
        <p class="mb-4">LEKTI로 각질층 효소 억제.</p>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">조절 성분 및 기전</h4>
        <ul class="list-disc list-inside space-y-2 mb-4">
          <li>디오스메틴, 컴파운드 K</li>
        </ul>
        <h4 class="font-bold text-lg mb-2 text-[#3D405B]">시중 제품 예시</h4>
        <p>설화수(예)</p>`
    }
  };

  // mean expression per age/sex (shortened same structure; values as in original)
  const expressionData = {
    "COL1A1": { labels: ["20대","30대","40대","50대","60대"], male:[12.76,13.74,12.52,12.24,11.76], female:[10.23,10.79,11.26,12.67,15.07] },
    "PINK1":  { labels: ["20대","30대","40대","50대","60대"], male:[-0.15,4.59,4.29,2.86,2.31],   female:[2.38,2.94,3.78,4.18,6.53] },
    "MSN":    { labels: ["20대","30대","40대","50대","60대"], male:[3.50,6.77,5.93,5.28,6.80],   female:[3.60,5.13,7.09,7.29,7.48] },
    "HAS2":   { labels: ["20대","30대","40대","50대","60대"], male:[11.04,5.14,11.82,10.41,7.21], female:[9.10,10.71,4.83,13.91,15.51] },
    "MLANA":  { labels: ["20대","30대","40대","50대","60대"], male:[6.11,2.22,2.47,2.19,-0.36],  female:[5.30,1.84,0.56,1.23,0.93] },
    "TFAP2A": { labels: ["20대","30대","40대","50대","60대"], male:[7.61,8.80,9.89,9.67,8.12],   female:[7.11,7.62,8.69,7.10,8.49] },
    "SOD1":   { labels: ["20대","30대","40대","50대","60대"], male:[-2.42,-3.52,-1.88,-3.54,-3.77], female:[-1.75,-2.58,-2.20,-2.27,-2.81] },
    "VDR":    { labels: ["20대","30대","40대","50대","60대"], male:[2.98,4.28,3.49,5.77,5.24],   female:[2.33,3.15,3.45,3.66,3.16] },
    "FLG":    { labels: ["20대","30대","40대","50대","60대"], male:[-2.69,-1.32,0.39,-4.97,-5.31], female:[-0.97,-1.20,-1.89,-1.85,0.18] },
    "AQP3":   { labels: ["20대","30대","40대","50대","60대"], male:[2.22,4.74,4.94,2.97,4.93],   female:[5.11,4.37,3.10,4.71,2.76] },
    "SPINK5": { labels: ["20대","30대","40대","50대","60대"], male:[-0.28,1.26,2.15,-0.44,0.24], female:[0.36,1.71,-0.32,0.62,3.25] }
  };

  // diagnosis mapping
  const recommendationData = {
    "COL1A1": {
      high:{status:"높음",message:"콜라겐 합성이 평균보다 높음.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"보습/자차 유지"},
      low: {status:"낮음",message:"콜라겐 합성이 평균보다 낮음.",ingredients:"펩타이드, 비타민 C, 컴파운드 K",products:"펩타이드 세럼 등",tips:"단백질 섭취/운동"}
    },
    "PINK1": {
      high:{status:"높음",message:"미토파지 기능 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"항산화 섭취/수면"},
      low: {status:"낮음",message:"미토파지 기능 저하.",ingredients:"아스타잔틴, NAD+",products:"아스타잔틴 세럼 등",tips:"항산화 위주 케어"}
    },
    "MSN": {
      high:{status:"높음",message:"세포 이동 기능 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"자극 최소화"},
      low: {status:"낮음",message:"재생 능력 저하 가능.",ingredients:"펩타이드(카텔리시딘)",products:"펩타이드 제품",tips:"재생 성분 위주"}
    },
    "HAS2": {
      high:{status:"높음",message:"히알루론산 합성 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"수분 유지"},
      low: {status:"낮음",message:"건조/탄력 저하 우려.",ingredients:"피세아탄놀, 설퓨레틴",products:"네오젠 V.BIOME",tips:"수분 충전"}
    },
    "MLANA": {
      high:{status:"높음",message:"색소 침착 경향 ↑.",ingredients:"레스베라트롤, EGCG, 알부틴",products:"티아미돌 라인",tips:"자차/미백"},
      low: {status:"낮음",message:"맑은 톤 경향.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"자차 유지"}
    },
    "TFAP2A": {
      high:{status:"높음",message:"색소 조절 ↑.",ingredients:"레티노이드",products:"레틴-A(처방)",tips:"자극 주의"},
      low: {status:"낮음",message:"색소 조절 ↓.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"자차 유지"}
    },
    "SOD1": {
      high:{status:"높음",message:"항산화 방어 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"항산화 습관"},
      low: {status:"낮음",message:"색소/노화 가속 우려.",ingredients:"레스베라트롤, EGCG, 비타민 C",products:"SOD 앰플 등",tips:"항산화 보강"}
    },
    "VDR": {
      high:{status:"높음",message:"VDR 활성 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"D3 관리"},
      low: {status:"낮음",message:"면역/색소 취약.",ingredients:"비타민 D3, 레티노이드",products:"D3+ 세럼",tips:"자차/장벽보강"}
    },
    "FLG": {
      high:{status:"높음",message:"장벽 튼튼.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"저자극 케어"},
      low: {status:"낮음",message:"장벽 약화/건조.",ingredients:"니아신아마이드, 우레아, 아피게닌",products:"필라그린/우레아",tips:"보습/장벽보강"}
    },
    "AQP3": {
      high:{status:"높음",message:"수분 통로 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"보습 유지"},
      low: {status:"낮음",message:"건조/탄력 저하.",ingredients:"글리세릴글루코사이드, 병풀",products:"아쿠아포린/센텔라",tips:"수분채널 활성"}
    },
    "SPINK5": {
      high:{status:"높음",message:"각질 조절 양호.",ingredients:"해당 없음",products:"현재 관리 유지",tips:"저자극"},
      low: {status:"낮음",message:"장벽 손상 우려.",ingredients:"디오스메틴, 컴파운드 K",products:"설화수 라인",tips:"장벽 강화"}
    }
  };

  // ===== DOM =====
  const loginView = document.getElementById('login-view');
  const reportsView = document.getElementById('reports-view');
  const detailView = document.getElementById('detail-view');
  const geneDashboardView = document.getElementById('gene-dashboard-view');
  const loginBtn = document.getElementById('login-btn');
  const addReportBtn = document.getElementById('add-report-btn');
  const backToListBtn = document.getElementById('back-to-list-btn');
  const navReportsBtn = document.getElementById('nav-reports');
  const navDashboardBtn = document.getElementById('nav-dashboard');
  const reportListContainer = document.getElementById('report-list-container');
  const reportDetailContainer = document.getElementById('report-detail-container');
  const noReportsMessage = document.getElementById('no-reports');
  const userIdDisplay = document.getElementById('user-id-display');
  const geneGrid = document.getElementById('gene-grid');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const geneModal = document.getElementById('gene-modal');
  const closeModalBtn = document.getElementById('close-gene-modal');
  const geneModalContent = document.getElementById('gene-modal-content');
  const modal = document.getElementById('modal');
  const modalMessage = document.getElementById('modal-message');
  const modalCloseBtnAlert = document.getElementById('modal-close-btn');

  let currentUserId = null;

  // ===== UI helpers =====
  const showMessageModal = (message) => { modalMessage.textContent = message; modal.classList.remove('hidden'); };
  modalCloseBtnAlert.addEventListener('click', () => modal.classList.add('hidden'));

  const toggleViews = (view) => {
    loginView.classList.add('hidden');
    reportsView.classList.add('hidden');
    detailView.classList.add('hidden');
    geneDashboardView.classList.add('hidden');
    if (view === 'login') loginView.classList.remove('hidden');
    else if (view === 'reports') reportsView.classList.remove('hidden');
    else if (view === 'detail') detailView.classList.remove('hidden');
    else if (view === 'gene-dashboard') geneDashboardView.classList.remove('hidden');
  };

  // ===== Router (single source of truth) =====
  function route() {
    const page = (location.hash || '#reports').replace('#', '');
    if (!currentUserId) { toggleViews('login'); return; }
    if (page === 'reports') toggleViews('reports');
    else if (page === 'dashboard') { toggleViews('gene-dashboard'); renderGeneCards('all'); }
    else if (page === 'detail') toggleViews('detail');
    else toggleViews('reports');
  }
  window.addEventListener('hashchange', route);
  window.addEventListener('load', route);

  // ===== Detail rendering =====
  const renderDetailedReport = (reportData) => {
    reportDetailContainer.innerHTML = `
      <h2 class="text-3xl font-bold text-[#3D405B] mb-4">시험 리포트 #${reportData.reportId}</h2>
      <p class="text-sm text-gray-500 mb-6">작성일: ${reportData.createdAt?.toDate ? reportData.createdAt.toDate().toLocaleString() : '날짜 없음'}</p>
      <div class="bg-[#F0F4F8] rounded-lg shadow-inner p-6 mb-8">
        <h3 class="text-2xl font-bold text-[#3D405B] mb-4">개인 유전자 값 분석 결과</h3>
        <div class="space-y-4">
          <p><strong>유전자:</strong> ${reportData.gene}</p>
          <p><strong>연령대/성별:</strong> ${reportData.age} / ${reportData.gender}</p>
          <p><strong>측정값:</strong> ${Number(reportData.value).toFixed(2)}</p>
          <p><strong>진단:</strong> <span class="font-bold">${reportData.status}</span></p>
          <p><strong>상세 분석:</strong> ${reportData.message}</p>
          <p><strong>추천 성분:</strong> ${reportData.ingredients}</p>
          <p><strong>추천 제품:</strong> ${reportData.products}</p>
          <p><strong>맞춤 팁:</strong> ${reportData.tips}</p>
        </div>
      </div>`;
    location.hash = 'detail';
  };

  // ===== Firestore: fetch user's reports =====
  const fetchReports = (userId) => {
    const reportsColRef = collection(db, \`artifacts/\${appId}/public/data/reports\`);
    const reportsQuery = query(reportsColRef, where("userId", "==", userId));
    onSnapshot(reportsQuery, (snapshot) => {
      const reports = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      reportListContainer.innerHTML = '';
      if (reports.length === 0) {
        noReportsMessage.classList.remove('hidden');
        return;
      }
      noReportsMessage.classList.add('hidden');
      // latest first
      reports.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
      reports.forEach(report => {
        const reportCard = document.createElement('div');
        reportCard.className = 'bg-white rounded-lg shadow-md p-4 cursor-pointer hover:bg-gray-50 transition-colors';
        const reportDate = report.createdAt?.toDate ? report.createdAt.toDate().toLocaleString() : '날짜 없음';
        reportCard.innerHTML = \`
          <p class="text-xl font-bold text-[#3D405B]">시험 리포트 #\${report.reportId}</p>
          <p class="text-sm text-gray-500">작성일: \${reportDate}</p>\`;
        reportCard.addEventListener('click', () => {
          // prefer stored fields; if missing, recompute
          const ageIndex = expressionData[report.gene]?.labels.indexOf(report.age) ?? -1;
          let computed = null;
          if (ageIndex >= 0) {
            const mean = report.gender === '남성'
              ? expressionData[report.gene].male[ageIndex]
              : expressionData[report.gene].female[ageIndex];
            const statusKey = (Number(report.value) > mean) ? 'high' : 'low';
            computed = recommendationData[report.gene][statusKey];
          }
          const full = {
            ...report,
            status: report.status || computed?.status || '정보없음',
            message: report.message || computed?.message || '정보없음',
            ingredients: report.ingredients || computed?.ingredients || '정보없음',
            products: report.products || computed?.products || '정보없음',
            tips: report.tips || computed?.tips || '정보없음',
          };
          renderDetailedReport(full);
        });
        reportListContainer.appendChild(reportCard);
      });
    }, (error) => {
      console.error("Error fetching reports:", error);
      showMessageModal(\`리포트 가져오기 오류: \${error.message}\`);
    });
  };

  // ===== Dashboard =====
  const renderGeneCards = (filter = 'all') => {
    geneGrid.innerHTML = '';
    Object.values(geneData).forEach(gene => {
      if (filter === 'all' || gene.category === filter) {
        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition-shadow';
        card.innerHTML = \`
          <h3 class="font-bold text-xl mb-2 text-[#3D405B]">\${gene.name}</h3>
          <p class="text-gray-600">\${gene.description}</p>\`;
        card.onclick = () => showGeneDetails(gene);
        geneGrid.appendChild(card);
      }
    });
  };
  const showGeneDetails = (gene) => {
    geneModalContent.innerHTML = \`
      <h2 class="text-3xl font-bold text-[#E07A5F] mb-4">\${gene.name} (\${gene.category})</h2>
      <p class="text-gray-600 mb-6">\${gene.description}</p>
      <div class="space-y-6 text-gray-700">\${gene.details}</div>\`;
    geneModal.classList.remove('hidden'); geneModal.classList.add('flex');
  };
  closeModalBtn.addEventListener('click', () => geneModal.classList.add('hidden'));
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => { b.classList.remove('bg-[#E07A5F]','text-white'); b.classList.add('bg-white','text-[#3D405B]'); });
      btn.classList.remove('bg-white','text-[#3D405B]'); btn.classList.add('bg-[#E07A5F]','text-white');
      renderGeneCards(btn.dataset.filter);
    });
  });

  // ===== Auth & navigation =====
  loginBtn.addEventListener('click', async () => {
    try { await signInAnonymously(auth); }
    catch (e) { console.error(e); showMessageModal(\`로그인 오류: \${e.message}\`); }
  });
  backToListBtn.addEventListener('click', () => { location.hash = 'reports'; });
  // anchors already have hashes; no JS override needed, but keep safety:
  navReportsBtn.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='reports'; });
  navDashboardBtn.addEventListener('click', (e)=>{ e.preventDefault(); location.hash='dashboard'; });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUserId = user.uid;
      userIdDisplay.textContent = \`사용자 ID: \${currentUserId}\`;
      if (location.hash !== '#reports') location.hash = 'reports';
      fetchReports(currentUserId);
    } else {
      currentUserId = null;
      location.hash = '#login';
      toggleViews('login');
    }
  });

  // initial sign-in on page load
  (async () => {
    try { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); }
    catch (error) { console.error("Initial login failed:", error); showMessageModal(\`자동 로그인 실패: \${error.message}\`); }
  })();
</script>

<!-- NOTE: the duplicate non-module script block from the original file was intentionally REMOVED -->
</body>
</html>
"""

with open('/mnt/data/index.fixed.html', 'w', encoding='utf-8') as f:
    f.write(html)

print("Saved to /mnt/data/index.fixed.html")
